<div class="container-fluid mt-4">
  <!-- Header with back button and patient info -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <button (click)="backClicked()" class="btn btn-outline-secondary">
      <span class="bi bi-arrow-left-square"></span>
      Go Back
    </button>
    <div class="text-end">
      <button
        class="btn btn-outline-primary me-2"
        *ngIf="patient"
        routerLink="/patient/edit/{{ patient.id }}"
      >
        <i class="bi bi-pencil me-1"></i> Edit Patient
      </button>
      <button class="btn btn-primary" (click)="printPatientRecord()">
        <i class="bi bi-printer me-1"></i> Print Record
      </button>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <!-- Patient Data -->
  <div *ngIf="!loading && patient">
    <!-- Patient Header -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            {{ patient.firstName }} {{ patient.lastName }}
            <small>(ID: {{ patient.id }})</small>
          </h4>
          <div>
            <span class="badge bg-light text-dark me-2">
              DOB: {{ patient.dateOfBirth | date }} ({{ patientAge }} years)
            </span>
            <span class="badge bg-light text-dark">
              Gender: {{ patient.genderID === 1 ? "Male" : "Female" }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <a
          class="nav-link"
          [class.active]="activeTab === 'overview'"
          (click)="setActiveTab('overview')"
        >
          Overview
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link"
          [class.active]="activeTab === 'medical'"
          (click)="setActiveTab('medical')"
        >
          Medical Info
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link"
          [class.active]="activeTab === 'allergies'"
          (click)="setActiveTab('allergies')"
        >
          Allergies & Alerts
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link"
          [class.active]="activeTab === 'medications'"
          (click)="setActiveTab('medications')"
        >
          Medications
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link"
          [class.active]="activeTab === 'visits'"
          (click)="setActiveTab('visits')"
        >
          Visits & Encounters
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link"
          [class.active]="activeTab === 'labs'"
          (click)="setActiveTab('labs')"
        >
          Lab Results
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link"
          [class.active]="activeTab === 'immunizations'"
          (click)="setActiveTab('immunizations')"
        >
          Immunizations
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link"
          [class.active]="activeTab === 'documents'"
          (click)="setActiveTab('documents')"
        >
          Documents
        </a>
      </li>
    </ul>

    <!-- Tab Content -->
    <div [ngSwitch]="activeTab">
      <!-- Overview Tab -->
      <div *ngSwitchCase="'overview'">
        <div class="row">
          <!-- Personal Information -->
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h5 class="mb-0">Personal Information</h5>
              </div>
              <div class="card-body">
                <table class="table table-sm table-borderless">
                  <tbody>
                    <tr>
                      <th>Date of Birth</th>
                      <td>{{ patient.dateOfBirth | date }}</td>
                    </tr>
                    <tr>
                      <th>Gender</th>
                      <td>{{ patient.genderID === 1 ? "Male" : "Female" }}</td>
                    </tr>
                    <tr>
                      <th>Contact</th>
                      <td>{{ patient.contactNumber }}</td>
                    </tr>
                    <tr>
                      <th>Email</th>
                      <td>{{ patient.email }}</td>
                    </tr>
                    <tr>
                      <th>Address</th>
                      <td>{{ patient.address }}</td>
                    </tr>
                    <tr *ngIf="patient.patientDetails?.roomNumber">
                      <th>Room Number</th>
                      <td>{{ patient.patientDetails.roomNumber }}</td>
                    </tr>
                    <tr *ngIf="patient.patientDetails?.bedNumber">
                      <th>Bed Number</th>
                      <td>{{ patient.patientDetails.bedNumber }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Emergency & Insurance -->
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h5 class="mb-0">Emergency & Insurance</h5>
              </div>
              <div class="card-body">
                <table class="table table-sm table-borderless">
                  <tbody>
                    <tr>
                      <th>Emergency Contact</th>
                      <td>
                        {{ patient.emergencyContactName }} ({{
                          patient.emergencyContactNumber
                        }})
                      </td>
                    </tr>
                    <tr>
                      <th>Insurance Provider</th>
                      <td>{{ patient.insuranceProvider }}</td>
                    </tr>
                    <tr>
                      <th>Insurance Number</th>
                      <td>{{ patient.insuranceNumber }}</td>
                    </tr>
                    <tr>
                      <th>Primary Doctor</th>
                      <td>{{ patient.patientDoctorName }}</td>
                    </tr>
                    <tr>
                      <th>Nurse</th>
                      <td>{{ patient.nursName }}</td>
                    </tr>
                    <tr *ngIf="patient.registrationDate">
                      <th>Registration Date</th>
                      <td>{{ patient.registrationDate | date }}</td>
                    </tr>
                    <tr *ngIf="patient.lastVisitDate">
                      <th>Last Visit</th>
                      <td>{{ patient.lastVisitDate | date }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Medical Info Tab -->
      <div *ngSwitchCase="'medical'">
        <div class="row mb-3">
          <div class="col">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Medical Information</h5>
              <button
                class="btn btn-sm btn-primary"
                (click)="toggleEditMedical()"
              >
                <i
                  class="bi"
                  [ngClass]="isEditingMedical ? 'bi-x-lg' : 'bi-pencil'"
                ></i>
                {{ isEditingMedical ? "Cancel" : "Edit Medical Info" }}
              </button>
            </div>
          </div>
        </div>

        <!-- View Mode -->
        <div *ngIf="!isEditingMedical">
          <div class="row">
            <!-- Medical History -->
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Medical History</h5>
                </div>
                <div class="card-body">
                  <table class="table table-sm">
                    <tbody>
                      <tr>
                        <th>Blood Type</th>
                        <td>
                          {{ medicalRecord?.bloodType || "Not recorded" }}
                        </td>
                      </tr>
                      <tr *ngIf="medicalRecord?.height">
                        <th>Height</th>
                        <td>{{ medicalRecord.height }} cm</td>
                      </tr>
                      <tr *ngIf="medicalRecord?.weight">
                        <th>Weight</th>
                        <td>{{ medicalRecord.weight }} kg</td>
                      </tr>
                      <tr *ngIf="medicalRecord?.bmi">
                        <th>BMI</th>
                        <td>{{ medicalRecord.bmi }}</td>
                      </tr>
                      <tr>
                        <th>Chronic Conditions</th>
                        <td>
                          {{
                            medicalRecord?.chronicConditions || "None reported"
                          }}
                        </td>
                      </tr>
                      <tr>
                        <th>Surgical History</th>
                        <td>
                          {{
                            medicalRecord?.surgicalHistory || "None reported"
                          }}
                        </td>
                      </tr>
                      <tr>
                        <th>Family Medical History</th>
                        <td>
                          {{
                            medicalRecord?.familyMedicalHistory ||
                              "None reported"
                          }}
                        </td>
                      </tr>
                      <tr>
                        <th>Social History</th>
                        <td>
                          {{ medicalRecord?.socialHistory || "None reported" }}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Current Treatment -->
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Current Treatment</h5>
                </div>
                <div class="card-body">
                  <div *ngIf="medicalRecord?.diagnosis">
                    <h6>Diagnosis</h6>
                    <p>{{ medicalRecord.diagnosis }}</p>
                  </div>

                  <div *ngIf="medicalRecord?.treatment">
                    <h6>Treatment Plan</h6>
                    <p>{{ medicalRecord.treatment }}</p>
                  </div>

                  <div *ngIf="medicalRecord?.medications">
                    <h6>Prescribed Medications</h6>
                    <p>{{ medicalRecord.medications }}</p>
                  </div>

                  <div *ngIf="medicalRecord?.notes">
                    <h6>Clinical Notes</h6>
                    <p>{{ medicalRecord.notes }}</p>
                  </div>

                  <div *ngIf="medicalRecord?.isFollowUpRequired">
                    <h6>Follow-up</h6>
                    <p>
                      Follow-up required on:
                      <strong>{{ medicalRecord.followUpDate | date }}</strong>
                    </p>
                  </div>

                  <div *ngIf="!medicalRecord">
                    <p class="text-muted">
                      No medical record information available.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Edit Mode -->
        <div *ngIf="isEditingMedical">
          <form
            [formGroup]="medicalRecordForm!"
            (ngSubmit)="saveMedicalRecord()"
          >
            <div class="row">
              <!-- Medical History (Edit Mode) -->
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Medical History</h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label for="bloodType" class="form-label"
                        >Blood Type</label
                      >
                      <select
                        class="form-select"
                        id="bloodType"
                        formControlName="bloodType"
                      >
                        <option value="">Unknown</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                      </select>
                    </div>

                    <div class="row mb-3">
                      <div class="col-md-4">
                        <label for="height" class="form-label"
                          >Height (cm)</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          id="height"
                          formControlName="height"
                          (blur)="calculateBMI()"
                        />
                      </div>
                      <div class="col-md-4">
                        <label for="weight" class="form-label"
                          >Weight (kg)</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          id="weight"
                          formControlName="weight"
                          (blur)="calculateBMI()"
                        />
                      </div>
                      <div class="col-md-4">
                        <label for="bmi" class="form-label">BMI</label>
                        <input
                          type="number"
                          class="form-control"
                          id="bmi"
                          formControlName="bmi"
                          readonly
                        />
                      </div>
                    </div>

                    <div class="mb-3">
                      <label for="chronicConditions" class="form-label"
                        >Chronic Conditions</label
                      >
                      <textarea
                        class="form-control"
                        id="chronicConditions"
                        rows="3"
                        formControlName="chronicConditions"
                      ></textarea>
                    </div>

                    <div class="mb-3">
                      <label for="surgicalHistory" class="form-label"
                        >Surgical History</label
                      >
                      <textarea
                        class="form-control"
                        id="surgicalHistory"
                        rows="3"
                        formControlName="surgicalHistory"
                      ></textarea>
                    </div>

                    <div class="mb-3">
                      <label for="familyMedicalHistory" class="form-label"
                        >Family Medical History</label
                      >
                      <textarea
                        class="form-control"
                        id="familyMedicalHistory"
                        rows="3"
                        formControlName="familyMedicalHistory"
                      ></textarea>
                    </div>

                    <div class="mb-3">
                      <label for="socialHistory" class="form-label"
                        >Social History</label
                      >
                      <textarea
                        class="form-control"
                        id="socialHistory"
                        rows="3"
                        formControlName="socialHistory"
                      ></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Current Treatment (Edit Mode) -->
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Current Treatment</h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label for="diagnosis" class="form-label"
                        >Diagnosis</label
                      >
                      <textarea
                        class="form-control"
                        id="diagnosis"
                        rows="3"
                        formControlName="diagnosis"
                      ></textarea>
                    </div>

                    <div class="mb-3">
                      <label for="treatment" class="form-label"
                        >Treatment Plan</label
                      >
                      <textarea
                        class="form-control"
                        id="treatment"
                        rows="3"
                        formControlName="treatment"
                      ></textarea>
                    </div>

                    <div class="mb-3">
                      <label for="medications" class="form-label"
                        >Prescribed Medications</label
                      >
                      <textarea
                        class="form-control"
                        id="medications"
                        rows="3"
                        formControlName="medications"
                      ></textarea>
                    </div>

                    <div class="mb-3">
                      <label for="notes" class="form-label"
                        >Clinical Notes</label
                      >
                      <textarea
                        class="form-control"
                        id="notes"
                        rows="3"
                        formControlName="notes"
                      ></textarea>
                    </div>

                    <div class="mb-3 form-check">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="isFollowUpRequired"
                        formControlName="isFollowUpRequired"
                      />
                      <label class="form-check-label" for="isFollowUpRequired"
                        >Follow-up Required</label
                      >
                    </div>

                    <div
                      class="mb-3"
                      *ngIf="
                        medicalRecordForm!.get('isFollowUpRequired')?.value
                      "
                    >
                      <label for="followUpDate" class="form-label"
                        >Follow-up Date</label
                      >
                      <input
                        type="date"
                        class="form-control"
                        id="followUpDate"
                        formControlName="followUpDate"
                      />
                    </div>
                  </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                  <button
                    type="button"
                    class="btn btn-secondary me-md-2"
                    (click)="toggleEditMedical()"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    class="btn btn-primary"
                    [disabled]="medicalRecordForm.invalid"
                  >
                    Save Medical Record
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Allergies & Alerts Tab -->
      <div *ngSwitchCase="'allergies'">
        <div class="card mb-3">
          <div
            class="card-header bg-light d-flex justify-content-between align-items-center"
          >
            <h5 class="mb-0">Allergies</h5>
            <button class="btn btn-sm btn-primary">
              <i class="bi bi-plus-circle me-1"></i> Add Allergy
            </button>
          </div>
          <div class="card-body">
            <div
              *ngIf="
                patient?.medicalRecord?.allergies?.length;
                else noAllergies
              "
            >
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Allergy</th>
                    <th>Type</th>
                    <th>Severity</th>
                    <th>Reaction</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let allergy of patient?.medicalRecord?.allergies">
                    <td>{{ allergy.name || "N/A" }}</td>
                    <td>{{ allergy.allergyType }}</td>
                    <td>
                      <span
                        [ngClass]="{
                          'badge bg-danger': allergy.severity === 'Severe',
                          'badge bg-warning text-dark':
                            allergy.severity === 'Moderate',
                          'badge bg-info': allergy.severity === 'Mild'
                        }"
                        >{{ allergy.severity || "Unknown" }}</span
                      >
                    </td>
                    <td>{{ allergy.reaction || "Not specified" }}</td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <ng-template #noAllergies>
              <p class="text-muted">No allergies recorded for this patient.</p>
            </ng-template>
          </div>
        </div>

        <!-- Medical Alerts -->
        <div class="card mb-3">
          <div
            class="card-header bg-light d-flex justify-content-between align-items-center"
          >
            <h5 class="mb-0">Medical Alerts</h5>
            <button class="btn btn-sm btn-primary">
              <i class="bi bi-plus-circle me-1"></i> Add Alert
            </button>
          </div>
          <div class="card-body">
            <p class="text-muted">
              No medical alerts recorded for this patient.
            </p>
          </div>
        </div>
      </div>

      <!-- Medications Tab -->
      <div *ngSwitchCase="'medications'">
        <div class="card mb-3">
          <div
            class="card-header bg-light d-flex justify-content-between align-items-center"
          >
            <h5 class="mb-0">Current Medications</h5>
            <button class="btn btn-sm btn-primary">
              <i class="bi bi-plus-circle me-1"></i> Add Medication
            </button>
          </div>
          <div class="card-body">
            <div *ngIf="medicalRecord?.medications?.length; else noMedications">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Medication</th>
                    <th>Dosage</th>
                    <th>Frequency</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let med of medicalRecord.medications">
                    <td>{{ med.name }}</td>
                    <td>{{ med.dosage }}</td>
                    <td>{{ med.frequency }}</td>
                    <td>{{ med.startDate | date : "shortDate" }}</td>
                    <td>
                      {{
                        med.endDate
                          ? (med.endDate | date : "shortDate")
                          : "Ongoing"
                      }}
                    </td>
                    <td>
                      <span
                        [ngClass]="{
                          'badge bg-success': med.isActive,
                          'badge bg-secondary': !med.isActive
                        }"
                        >{{ med.isActive ? "Active" : "Discontinued" }}</span
                      >
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <ng-template #noMedications>
              <p class="text-muted">
                No medications recorded for this patient.
              </p>
            </ng-template>
          </div>
        </div>

        <!-- Medication History -->
        <div class="card mb-3">
          <div class="card-header bg-light">
            <h5 class="mb-0">Medication History</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">
              Historical medication data is not available.
            </p>
          </div>
        </div>
      </div>

      <!-- Visits Tab -->
      <div *ngSwitchCase="'visits'">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Recent Medical Visits</h5>
          <button class="btn btn-sm btn-primary" (click)="scheduleNewVisit()">
            <i class="bi bi-calendar-plus me-1"></i> Schedule Visit
          </button>
        </div>

        <ng-container *ngIf="medicalRecord?.visits?.length > 0; else noVisits">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Provider</th>
                  <th>Diagnosis</th>
                  <th>Medication</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let visit of medicalRecord.visits">
                  <td>{{ visit.visitDate | date : "mediumDate" }}</td>
                  <td>{{ visit.visitType }}</td>
                  <td>{{ visit.providerName || "N/A" }}</td>
                  <td>
                    <div>
                      <ng-container
                        *ngIf="visit.diagnosis?.length > 0; else noDiagnosis"
                      >
                        <button
                          class="btn btn-sm btn-outline-secondary"
                          (click)="visit.showDiagnosis = !visit.showDiagnosis"
                        >
                          {{ visit.diagnosis.length }} diagnosis{{
                            visit.diagnosis.length > 1 ? "es" : ""
                          }}
                          <i
                            class="bi"
                            [ngClass]="
                              visit.showDiagnosis
                                ? 'bi-chevron-up'
                                : 'bi-chevron-down'
                            "
                          ></i>
                        </button>

                        <div
                          *ngIf="visit.showDiagnosis"
                          class="mt-2 p-2 border rounded bg-light"
                        >
                          <ul class="list-unstyled mb-0">
                            <li
                              *ngFor="let diag of visit.diagnosis"
                              class="mb-1"
                            >
                              <strong>Code:</strong> {{ diag.diagnosisCode }}
                              <br />
                              <strong>Description:</strong>
                              {{ diag.description }} <br />
                              <strong>Date:</strong>
                              {{ diag.diagnosisDate | date : "shortDate" }}
                              <br />
                              <strong>Status:</strong>
                              <span
                                [ngClass]="
                                  diag.isActive ? 'text-success' : 'text-danger'
                                "
                              >
                                {{ diag.isActive ? "Active" : "Inactive" }}
                              </span>
                            </li>
                          </ul>
                        </div>
                      </ng-container>
                      <ng-template #noDiagnosis>None</ng-template>
                    </div>
                  </td>
                  <td>
                    <div>
                      <ng-container
                        *ngIf="visit.medication?.length > 0; else noMedications"
                      >
                        <button
                          class="btn btn-sm btn-outline-secondary"
                          (click)="visit.showMedication = !visit.showMedication"
                        >
                          {{ visit.medication.length }} medication{{
                            visit.medication.length > 1 ? "s" : ""
                          }}
                          <i
                            class="bi"
                            [ngClass]="
                              visit.showMedication
                                ? 'bi-chevron-up'
                                : 'bi-chevron-down'
                            "
                          ></i>
                        </button>

                        <div
                          *ngIf="visit.showMedication"
                          class="mt-2 p-2 border rounded bg-light"
                        >
                          <ul class="list-unstyled mb-0">
                            <li
                              *ngFor="let med of visit.medication"
                              class="mb-1"
                            >
                              <strong>Name:</strong> {{ med.name }} <br />
                              <strong>Dosage:</strong> {{ med.dosage }} <br />
                              <strong>Frequency:</strong> {{ med.frequency }}
                              <br />
                              <strong>Start Date:</strong>
                              {{ med.startDate | date : "dd/MM/yyy" }} <br />
                              <strong>End Date:</strong>
                              {{
                                med.endDate
                                  ? (med.endDate | date : "dd/MM/yyy")
                                  : "Ongoing"
                              }}
                              <br />
                              <strong>Status:</strong>
                              <span
                                [ngClass]="
                                  med.isActive ? 'text-success' : 'text-danger'
                                "
                              >
                                {{ med.isActive ? "Active" : "Discontinued" }}
                              </span>
                            </li>
                          </ul>
                        </div>
                      </ng-container>
                      <ng-template #noMedications>None</ng-template>
                    </div>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button
                        class="btn btn-outline-info"
                        (click)="viewVisitDetails(visit.id!)"
                        title="View details"
                      >
                        <i class="bi bi-eye"></i>
                      </button>
                      <button
                        class="btn btn-outline-secondary"
                        (click)="printVisitSummary(visit.id!)"
                        title="Print summary"
                      >
                        <i class="bi bi-printer"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>

        <ng-template #noVisits>
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No recent visits recorded for this patient.
          </div>
        </ng-template>
      </div>

      <!-- Lab Results Tab -->
      <div *ngSwitchCase="'labs'">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Laboratory Results</h5>
          <button class="btn btn-sm btn-primary" (click)="orderNewLab()">
            <i class="bi bi-file-earmark-plus me-1"></i> Order New Lab
          </button>
        </div>

        <div *ngIf="medicalRecord?.labResults?.length > 0; else noLabResults">
          <div class="accordion" id="labResultsAccordion">
            <div
              class="accordion-item"
              *ngFor="let labResult of medicalRecord.labResults; let i = index"
            >
              <h2 class="accordion-header" [id]="'heading' + i">
                <button
                  class="accordion-button"
                  [class.collapsed]="i !== 0"
                  type="button"
                  data-bs-toggle="collapse"
                  [attr.data-bs-target]="'#collapse' + i"
                  [attr.aria-expanded]="i === 0 ? 'true' : 'false'"
                  [attr.aria-controls]="'collapse' + i"
                >
                  {{ labResult.testDate | date }} - {{ labResult.testName }}
                </button>
              </h2>
              <div
                [id]="'collapse' + i"
                class="accordion-collapse collapse"
                [class.show]="i === 0"
                [attr.aria-labelledby]="'heading' + i"
                data-bs-parent="#labResultsAccordion"
              >
                <div class="accordion-body">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Test</th>
                        <th>Result</th>
                        <th>Reference Range</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let parameter of labResult.parameters">
                        <td>{{ parameter.parameterName }}</td>
                        <td>{{ parameter.value }} {{ parameter.unit }}</td>
                        <td>{{ parameter.referenceRange }}</td>
                        <td>
                          <span
                            [ngClass]="{
                              'badge bg-danger':
                                parameter.status === 'Critical',
                              'badge bg-warning text-dark':
                                parameter.status === 'Abnormal',
                              'badge bg-success': parameter.status === 'Normal'
                            }"
                            >{{ parameter.status }}</span
                          >
                        </td>
                      </tr>
                    </tbody>
                  </table>
                  <div class="mt-3">
                    <strong>Ordered By:</strong> {{ labResult.orderedBy }}<br />
                    <strong>Test Location:</strong> {{ labResult.testLocation
                    }}<br />
                    <strong>Notes:</strong>
                    {{ labResult.notes || "No additional notes" }}
                  </div>
                  <div class="d-flex justify-content-end mt-3">
                    <button
                      class="btn btn-sm btn-outline-primary me-2"
                      (click)="printLabResult(labResult.id)"
                    >
                      <i class="bi bi-printer me-1"></i> Print
                    </button>
                    <button
                      class="btn btn-sm btn-outline-secondary"
                      (click)="downloadLabPDF(labResult.id)"
                    >
                      <i class="bi bi-download me-1"></i> Download PDF
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <ng-template #noLabResults>
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              No laboratory results found for this patient.
            </div>
          </ng-template>
        </div>

        <!-- Immunizations Tab -->
        <div *ngSwitchCase="'immunizations'">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Immunization Record</h5>
            <button
              class="btn btn-sm btn-primary"
              (click)="addNewImmunization()"
            >
              <i class="bi bi-shield-plus me-1"></i> Add Immunization
            </button>
          </div>

          <div
            *ngIf="
              medicalRecord?.immunizations?.length > 0;
              else noImmunizations
            "
          >
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Vaccine</th>
                    <th>Date Administered</th>
                    <th>Dose</th>
                    <th>Administered By</th>
                    <th>Location</th>
                    <th>Next Due</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let immunization of medicalRecord.immunizations">
                    <td>{{ immunization.vaccineName }}</td>
                    <td>{{ immunization.administeredDate | date }}</td>
                    <td>
                      {{ immunization.doseNumber || "1" }} of
                      {{ immunization.totalDoses || "1" }}
                    </td>
                    <td>{{ immunization.administeredBy }}</td>
                    <td>{{ immunization.location }}</td>
                    <td>{{ immunization.nextDueDate | date }}</td>
                    <td>
                      <span
                        [ngClass]="{
                          'badge bg-success':
                            immunization.status === 'Completed',
                          'badge bg-warning text-dark':
                            immunization.status === 'Pending',
                          'badge bg-info': immunization.status === 'Scheduled'
                        }"
                        >{{ immunization.status }}</span
                      >
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <button
                          class="btn btn-outline-secondary"
                          (click)="editImmunization(immunization.id)"
                        >
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button
                          class="btn btn-outline-danger"
                          (click)="deleteImmunization(immunization.id)"
                        >
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <ng-template #noImmunizations>
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              No immunization records found for this patient.
            </div>
          </ng-template>
        </div>

        <!-- Documents Tab -->
        <div *ngSwitchCase="'documents'">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Patient Documents</h5>
            <div>
              <button
                class="btn btn-sm btn-outline-secondary me-2"
                (click)="viewDocumentHistory()"
              >
                <i class="bi bi-clock-history me-1"></i> View History
              </button>
              <button class="btn btn-sm btn-primary" (click)="uploadDocument()">
                <i class="bi bi-upload me-1"></i> Upload Document
              </button>
            </div>
          </div>

          <div *ngIf="medicalRecord?.documents?.length > 0; else noDocuments">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Document Name</th>
                    <th>Type</th>
                    <th>Date Added</th>
                    <th>Added By</th>
                    <th>Size</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let document of medicalRecord.documents">
                    <td>{{ document.name }}</td>
                    <td>{{ document.type }}</td>
                    <td>{{ document.dateAdded | date }}</td>
                    <td>{{ document.addedBy }}</td>
                    <td>{{ document.size | fileSize }}</td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <button
                          class="btn btn-outline-primary"
                          (click)="viewDocument(document.id)"
                        >
                          <i class="bi bi-eye"></i>
                        </button>
                        <button
                          class="btn btn-outline-secondary"
                          (click)="downloadDocument(document.id)"
                        >
                          <i class="bi bi-download"></i>
                        </button>
                        <button
                          class="btn btn-outline-danger"
                          (click)="deleteDocument(document.id)"
                        >
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <ng-template #noDocuments>
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              No documents available for this patient.
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Print Modal (Hidden by default) -->
    <div
      class="modal fade"
      id="printModal"
      tabindex="-1"
      aria-labelledby="printModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="printModalLabel">
              Print Patient Record
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="form-check mb-3" *ngFor="let section of printOptions">
              <input
                class="form-check-input"
                type="checkbox"
                [id]="'print' + section.id"
                [(ngModel)]="section.selected"
              />
              <label class="form-check-label" [for]="'print' + section.id">
                {{ section.name }}
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              (click)="executePrint()"
            >
              <i class="bi bi-printer me-1"></i> Print Selected
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- New Visit Modal (Hidden by default) -->
    <div
      class="modal fade"
      id="scheduleVisitModal"
      tabindex="-1"
      aria-labelledby="scheduleVisitModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="scheduleVisitModalLabel">
              Schedule New Visit
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form [formGroup]="visitForm">
              <div class="mb-3">
                <label for="visitType" class="form-label">Visit Type</label>
                <select
                  class="form-select"
                  id="visitType"
                  formControlName="visitType"
                >
                  <option value="">Select type...</option>
                  <option value="Regular Checkup">Regular Checkup</option>
                  <option value="Specialist Consultation">
                    Specialist Consultation
                  </option>
                  <option value="Follow-up">Follow-up</option>
                  <option value="Emergency">Emergency</option>
                  <option value="Procedure">Procedure</option>
                  <option value="Surgery">Surgery</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="visitDate" class="form-label">Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="visitDate"
                  formControlName="visitDate"
                />
              </div>
              <div class="mb-3">
                <label for="visitTime" class="form-label">Time</label>
                <input
                  type="time"
                  class="form-control"
                  id="visitTime"
                  formControlName="visitTime"
                />
              </div>
              <div class="mb-3">
                <label for="provider" class="form-label">Provider</label>
                <select
                  class="form-select"
                  id="provider"
                  formControlName="providerName"
                >
                  <option value="">Select provider...</option>
                  <option
                    *ngFor="let provider of providers"
                    [value]="provider.name"
                  >
                    {{ provider.name }} ({{ provider.specialty }})
                  </option>
                </select>
              </div>
              <div class="mb-3">
                <label for="visitNotes" class="form-label">Notes</label>
                <textarea
                  class="form-control"
                  id="visitNotes"
                  rows="3"
                  formControlName="notes"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              [disabled]="visitForm.invalid"
              (click)="submitVisit()"
            >
              Schedule Visit
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Document Modal (Hidden by default) -->
    <div
      class="modal fade"
      id="uploadDocumentModal"
      tabindex="-1"
      aria-labelledby="uploadDocumentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="uploadDocumentModalLabel">
              Upload Document
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form [formGroup]="documentForm">
              <div class="mb-3">
                <label for="documentName" class="form-label"
                  >Document Name</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="documentName"
                  formControlName="name"
                />
              </div>
              <div class="mb-3">
                <label for="documentType" class="form-label"
                  >Document Type</label
                >
                <select
                  class="form-select"
                  id="documentType"
                  formControlName="type"
                >
                  <option value="">Select type...</option>
                  <option value="Lab Report">Lab Report</option>
                  <option value="Imaging Report">Imaging Report</option>
                  <option value="Discharge Summary">Discharge Summary</option>
                  <option value="Consent Form">Consent Form</option>
                  <option value="Referral Letter">Referral Letter</option>
                  <option value="Insurance Document">Insurance Document</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="documentFile" class="form-label">File</label>
                <input
                  type="file"
                  class="form-control"
                  id="documentFile"
                  (change)="onFileSelected($event)"
                />
              </div>
              <div class="mb-3">
                <label for="documentDescription" class="form-label"
                  >Description</label
                >
                <textarea
                  class="form-control"
                  id="documentDescription"
                  rows="3"
                  formControlName="description"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              [disabled]="documentForm.invalid || !selectedFile"
              (click)="submitDocument()"
            >
              Upload Document
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
