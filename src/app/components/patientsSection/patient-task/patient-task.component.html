<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1>Patient Care Tasks</h1>
    </div>
    <div class="col-auto">
      <button
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#newTaskModal"
      >
        <i class="bi bi-plus-circle"></i> New Task
      </button>
    </div>
    <div class="col-auto">
      <button (click)="backClicked()" class="btn btn-outline-danger">
        <i class="bi bi-arrow-left-square"></i>
        Go Back
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="form-group">
        <label for="patientFilter">Patient</label>
        <select
          class="form-select"
          id="patientFilter"
          [(ngModel)]="selectedPatientId"
          (change)="applyFilters()"
        >
          <option [ngValue]="null">All Patients</option>
          <option *ngFor="let patient of patients" [value]="patient.id">
            {{ patient.firstName }} {{ patient.lastName }} ({{
              patient.patientDetails.roomNumber
            }}
            - {{ patient.patientDetails.bedNumber }})
          </option>
        </select>
      </div>
    </div>
    <div class="col-md-3">
      <div class="form-group">
        <label for="statusFilter">Status</label>
        <select
          class="form-select"
          id="statusFilter"
          [(ngModel)]="selectedStatus"
          (change)="applyFilters()"
        >
          <option [ngValue]="null">All Statuses</option>
          <option [ngValue]="TaskStatus.NotStarted">Not Started</option>
          <option [ngValue]="TaskStatus.InProgress">In Progress</option>
          <option [ngValue]="TaskStatus.Completed">Completed</option>
          <option [ngValue]="TaskStatus.Overdue">Overdue</option>
        </select>
      </div>
    </div>
    <div class="col-md-3">
      <div class="form-group">
        <label for="priorityFilter">Priority</label>
        <select
          class="form-select"
          id="priorityFilter"
          [(ngModel)]="selectedPriority"
          (change)="applyFilters()"
        >
          <option [ngValue]="null">All Priorities</option>
          <option [ngValue]="TaskPriority.Low">Low</option>
          <option [ngValue]="TaskPriority.Medium">Medium</option>
          <option [ngValue]="TaskPriority.High">High</option>
          <option [ngValue]="TaskPriority.Critical">Critical</option>
        </select>
      </div>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-outline-secondary" (click)="refreshTasks()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Task List -->
  <div class="row">
    <div class="col">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Priority</th>
              <th>Patient</th>
              <th>Task</th>
              <th>Due Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of filteredTasks">
              <td>
                <span
                  class="badge rounded-pill"
                  [ngClass]="getPriorityClass(task.priority)"
                >
                  {{ TaskPriority[task.priority] }}
                </span>
              </td>
              <td>{{ getPatientName(task.patientId) }}</td>
              <td>
                <div class="fw-bold">{{ task.title }}</div>
                <small class="text-muted">{{ task.description }}</small>
                <span *ngIf="task.isRecurring" class="badge bg-info ms-2">
                  <i class="bi bi-arrow-repeat"></i> {{ task.recurringPattern }}
                </span>
              </td>
              <td>
                {{ task.dueDate | date : "short" }}
                <div
                  *ngIf="task.status === TaskStatus.Overdue"
                  class="text-danger small"
                >
                  <i class="bi bi-exclamation-triangle-fill"></i> Overdue
                </div>
              </td>
              <td>
                <span [ngClass]="getStatusClass(task.status)">
                  {{ TaskStatus[task.status] }}
                </span>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <!-- Start button -->
                  <button
                    class="btn btn-outline-primary"
                    [disabled]="isTaskCompleted(task)"
                    (click)="updateTaskStatus(task, TaskStatus.InProgress)"
                    *ngIf="isTaskStartable(task)"
                  >
                    <i class="bi bi-play-fill"></i> Start
                  </button>

                  <!-- Complete button -->
                  <button
                    class="btn btn-outline-success"
                    [disabled]="isTaskCompleted(task)"
                    (click)="updateTaskStatus(task, TaskStatus.Completed)"
                    *ngIf="isTaskCompletable(task)"
                  >
                    <i class="bi bi-check-lg"></i> Complete
                  </button>

                  <button
                    class="btn btn-outline-secondary dropdown-toggle"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <i class="bi bi-three-dots"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a
                        class="dropdown-item"
                        (click)="openEditModal(task)"
                        data-bs-toggle="modal"
                        data-bs-target="#editTaskModal"
                        style="cursor: pointer"
                      >
                        <i class="bi bi-pencil"></i> Edit
                      </a>
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        (click)="openViewModal(task)"
                        data-bs-toggle="modal"
                        data-bs-target="#viewDetailsModal"
                        style="cursor: pointer"
                      >
                        <i class="bi bi-eye"></i> View Details
                      </a>
                    </li>
                    <li><hr class="dropdown-divider" /></li>
                    <li>
                      <a
                        class="dropdown-item text-danger"
                        (click)="deleteTask(task.id)"
                        style="cursor: pointer"
                      >
                        <i class="bi bi-trash"></i> Delete
                      </a>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Empty state message -->
      <div *ngIf="filteredTasks.length === 0" class="text-center py-5">
        <div class="mb-3">
          <i class="bi bi-clipboard-check fs-1 text-muted"></i>
        </div>
        <h5>No tasks found</h5>
        <p class="text-muted">Try changing your filters or create a new task</p>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#newTaskModal"
        >
          <i class="bi bi-plus-circle"></i> Create Task
        </button>
      </div>
    </div>
  </div>
</div>

<!-- New Task Modal -->
<div
  class="modal fade"
  id="newTaskModal"
  tabindex="-1"
  aria-labelledby="newTaskModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newTaskModalLabel">Create New Task</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="taskPatient" class="form-label">Patient *</label>
              <select
                class="form-select"
                id="taskPatient"
                [(ngModel)]="newTask.patientId"
                name="patientId"
                required
              >
                <option [ngValue]="null">Choose patient...</option>
                <option *ngFor="let patient of patients" [value]="patient.id">
                  {{ patient.firstName }} {{ patient.lastName }} -
                  {{ patient.patientDetails.roomNumber }}
                </option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="taskPriority" class="form-label">Priority</label>
              <select
                class="form-select"
                id="taskPriority"
                [(ngModel)]="newTask.priority"
                name="priority"
                required
              >
                <option [ngValue]="TaskPriority.Low">Low</option>
                <option [ngValue]="TaskPriority.Medium">Medium</option>
                <option [ngValue]="TaskPriority.High">High</option>
                <option [ngValue]="TaskPriority.Critical">Critical</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label for="taskTitle" class="form-label">Task Title *</label>
            <input
              type="text"
              class="form-control"
              id="taskTitle"
              [(ngModel)]="newTask.title"
              name="title"
              placeholder="Enter task title"
              required
            />
          </div>

          <div class="mb-3">
            <label for="taskDescription" class="form-label">Description</label>
            <textarea
              class="form-control"
              id="taskDescription"
              [(ngModel)]="newTask.description"
              name="description"
              rows="3"
              placeholder="Enter task details"
            ></textarea>
          </div>

          <div class="mb-3">
            <label for="taskDueDate" class="form-label">Due Date *</label>
            <input
              type="datetime-local"
              class="form-control"
              id="taskDueDate"
              [(ngModel)]="newTask.dueDate"
              name="dueDate"
              required
            />
            <small class="form-text text-muted"
              >Select date and time for task</small
            >
          </div>

          <div class="mb-3 form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="taskIsRecurring"
              [(ngModel)]="newTask.isRecurring"
              name="isRecurring"
            />
            <label class="form-check-label" for="taskIsRecurring">
              Recurring Task
            </label>
          </div>

          <div class="mb-3" *ngIf="newTask.isRecurring">
            <label for="taskRecurringPattern" class="form-label">
              Recurring Pattern
            </label>
            <select
              class="form-select"
              id="taskRecurringPattern"
              [(ngModel)]="newTask.recurringPattern"
              name="recurringPattern"
            >
              <option value="daily">Daily</option>
              <option value="every 4 hours">Every 4 hours</option>
              <option value="every 6 hours">Every 6 hours</option>
              <option value="every 8 hours">Every 8 hours</option>
              <option value="every 12 hours">Every 12 hours</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="createTask()">
          Create Task
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Task Modal -->
<div
  class="modal fade"
  id="editTaskModal"
  tabindex="-1"
  aria-labelledby="editTaskModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body" *ngIf="selectedTask">
        <form>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="editTaskPatient" class="form-label">Patient</label>
              <select
                class="form-select"
                id="editTaskPatient"
                [(ngModel)]="selectedTask.patientId"
                name="patientId"
                required
              >
                <option *ngFor="let patient of patients" [value]="patient.id">
                  {{ patient.firstName }} {{ patient.lastName }} -
                  {{ patient.patientDetails.roomNumber }}
                </option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="editTaskPriority" class="form-label">Priority</label>
              <select
                class="form-select"
                id="editTaskPriority"
                [(ngModel)]="selectedTask.priority"
                name="priority"
              >
                <option [ngValue]="TaskPriority.Low">Low</option>
                <option [ngValue]="TaskPriority.Medium">Medium</option>
                <option [ngValue]="TaskPriority.High">High</option>
                <option [ngValue]="TaskPriority.Critical">Critical</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label for="editTaskTitle" class="form-label">Task Title</label>
            <input
              type="text"
              class="form-control"
              id="editTaskTitle"
              [(ngModel)]="selectedTask.title"
              name="title"
              required
            />
          </div>

          <div class="mb-3">
            <label for="editTaskDescription" class="form-label"
              >Description</label
            >
            <textarea
              class="form-control"
              id="editTaskDescription"
              [(ngModel)]="selectedTask.description"
              name="description"
              rows="3"
            ></textarea>
          </div>

          <div class="mb-3">
            <label for="editTaskDueDate" class="form-label">Due Date</label>
            <input
              type="datetime-local"
              class="form-control"
              id="editTaskDueDate"
              [(ngModel)]="selectedTask.dueDate"
              name="dueDate"
              required
            />
          </div>

          <div class="mb-3 form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="editTaskIsRecurring"
              [(ngModel)]="selectedTask.isRecurring"
              name="isRecurring"
            />
            <label class="form-check-label" for="editTaskIsRecurring">
              Recurring Task
            </label>
          </div>

          <div class="mb-3" *ngIf="selectedTask.isRecurring">
            <label for="editTaskRecurringPattern" class="form-label">
              Recurring Pattern
            </label>
            <select
              class="form-select"
              id="editTaskRecurringPattern"
              [(ngModel)]="selectedTask.recurringPattern"
              name="recurringPattern"
            >
              <option value="daily">Daily</option>
              <option value="every 4 hours">Every 4 hours</option>
              <option value="every 6 hours">Every 6 hours</option>
              <option value="every 8 hours">Every 8 hours</option>
              <option value="every 12 hours">Every 12 hours</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="updateTask()">
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Details Modal -->
<div
  class="modal fade"
  id="viewDetailsModal"
  tabindex="-1"
  aria-labelledby="viewDetailsModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewDetailsModalLabel">Task Details</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body" *ngIf="selectedTask">
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Patient:</strong>
            <p>{{ getPatientName(selectedTask.patientId) }}</p>
          </div>
          <div class="col-md-6">
            <strong>Priority:</strong>
            <p>
              <span
                class="badge rounded-pill"
                [ngClass]="getPriorityClass(selectedTask.priority)"
              >
                {{ TaskPriority[selectedTask.priority] }}
              </span>
            </p>
          </div>
        </div>

        <div class="mb-3">
          <strong>Task Title:</strong>
          <p>{{ selectedTask.title }}</p>
        </div>

        <div class="mb-3">
          <strong>Description:</strong>
          <p>{{ selectedTask.description || "No description provided" }}</p>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Due Date:</strong>
            <p>{{ selectedTask.dueDate | date : "medium" }}</p>
          </div>
          <div class="col-md-6">
            <strong>Status:</strong>
            <p [ngClass]="getStatusClass(selectedTask.status)">
              {{ TaskStatus[selectedTask.status] }}
            </p>
          </div>
        </div>

        <div class="mb-3" *ngIf="selectedTask.isRecurring">
          <strong>Recurring Pattern:</strong>
          <p>
            <span class="badge bg-info">
              <i class="bi bi-arrow-repeat"></i>
              {{ selectedTask.recurringPattern }}
            </span>
          </p>
        </div>

        <div class="mb-3" *ngIf="selectedTask.createdAt">
          <strong>Created:</strong>
          <p>{{ selectedTask.createdAt | date : "medium" }}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
